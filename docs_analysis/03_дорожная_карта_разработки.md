# Дорожная карта разработки алгоритма КУШ

> **Дата обновления**: 2025-11-18
> **Статус проекта**: MVP в процессе (~70% завершено)

---

## Общий прогресс

| Фаза | Статус | Прогресс |
|------|--------|----------|
| 1. Базовая инфраструктура | Завершена | 100% |
| 2. Функции проверки ошибок | Завершена | 100% |
| 3. Управление оборудованием | В процессе | 85% |
| 4. Система блокировок | В процессе | 40% |
| 5. Автоматический режим | В процессе | 75% |
| 6. Отчетность и наработка | Не начата | 0% |
| 7. Настройки | Частично | 30% |
| 8. Тестирование | В процессе | 50% |

---

## Фаза 1: Базовая инфраструктура - ЗАВЕРШЕНА

### 1.1 Структуры данных
**Статус**: Завершено

- [x] ST_Bunker - структура бункера-накопителя
  - Вибраторы (4 шт.) - `ARRAY [1..4] OF ST_Motor`
  - Вибропитатель (2 двигателя) - `ARRAY [1..2] OF ST_MotorVibFeeder`
  - Датчик ограждения (люка) - `fbStateHatch`
  - Светофор - `qxLightRed, qxLightYellow, qxLightGreen`
  - Весы бункерные - `rWeight, rWeightModbusReg`
  - Кнопки ПМУ

- [x] ST_ConveyorBasic / ST_ConveyorPrefabricated - структура сборного конвейера
  - Приводы (2 шт.) - `ARRAY [1..2] OF ST_MotorWithFeedback`
  - Металлодетектор - `fbYE1`
  - Весы конвейерные - *(требует добавления)*
  - Датчики безопасности (ZQ, HQ, SQ, GS, YS)
  - Сигнализация - `xHLA, xSoundAlarm`

- [x] ST_Dumper (EXTENDS ST_ConveyorBasic) - структура отвалообразователя
  - Приводы ленты (2 шт.) - наследуется
  - Приводы поворота (2 шт.) - `ARRAY [1..2] OF ST_MotorWithReverse`
  - Концевые выключатели - `fbEndSwitchRight, fbEndSwitchLeft`
  - Датчики безопасности - наследуется

- [x] ST_Motor, ST_MotorWithFeedback, ST_MotorWithReverse, ST_MotorVibFeeder
- [x] ST_VFD - структура частотного преобразователя
- [x] ST_Commands - команды SCADA
- [x] ST_CommonSignals - общие сигналы системы
- [x] ST_AlarmSetpoints - уставки сигнализации
- [x] ST_PreStartAlarmSettings - настройки предпускового оповещения
- [x] ST_BunkerVibratorSettings - настройки вибраторов бункера

**Не реализовано (низкий приоритет):**
- [ ] ST_SystemKIUM - структура учета мощности (данные разбросаны)
- [ ] ST_ShihtaRecipe - задание пропорции (используется массив в ST_Commands)

### 1.2 Перечисления
**Статус**: Завершено

- [x] E_StateFeedback - состояния обратной связи
- [x] E_StateMechanism - состояния механизма
- [x] E_StateRemote - режимы управления (Manual/Remote/Automatic)
- [x] E_StageWithPreStartAlarm - стадии запуска с ППО
- [x] E_LightColor - цвета светофора
- [x] E_VibratorState - состояния вибратора (IDLE/ACTIVE_WORK/PAUSE_VIBRATOR/PAUSE_FB)
- [x] E_AlarmSetpoints - типы уставок (L/LL/H/HH)

---

## Фаза 2: Функции проверки ошибок - ЗАВЕРШЕНА

### 2.1 Проверки бункера
**Статус**: Завершено

- [x] FC_Bunker_GetErrorBunker - агрегация ошибок бункера
- [x] FC_Bunker_GetErrorMotorVibrator - ошибки вибраторов
- [x] FC_Bunker_GetErrorMotorVibFeeder - ошибки вибропитателей
- [x] FC_Bunker_GetErrorWeight - проверка заполненности бункеров (2+ пустых)
- [x] FC_Bunker_CheckWeight - проверка веса
- [x] FC_Bunker_SetLightColor - управление цветом светофора

### 2.2 Проверки конвейера
**Статус**: Завершено

- [x] FC_Conveyor_GetErrorCommon - агрегация ошибок конвейера
- [x] FC_Conveyor_GetErrorMotor - ошибки приводов
- [x] FC_Conveyor_GetErrorSensors - ошибки датчиков (ZQ, HQ, SQ, GS, YS, YE)

### 2.3 Проверки отвалообразователя
**Статус**: Завершено

- [x] FC_Dumper_GetErrorCommon - агрегация ошибок отвалообразователя
- [x] FC_Dumper_GetErrorSensors - ошибки датчиков

### 2.4 Общесистемные проверки
**Статус**: Частично завершено

- [x] FC_Get_ErrorCommon - агрегация всех ошибок системы
- [x] FC_VFD_ChangeReadMode - переключение режима чтения ПЧ
- [x] FC_MotorSyncronizedWork - синхронизированная работа моторов
- [ ] FC_KIUM_CheckBudget - проверка бюджета мощности (базовая проверка в FC_Get_ErrorCommon)
- [ ] FC_KIUM_CalculatePower - расчет текущей мощности

---

## Фаза 3: Управление оборудованием - В ПРОЦЕССЕ (85%)

### 3.1 Управление бункером
**Статус**: В основном завершено

- [x] FB_BunkerControl - основной контроллер бункера
  - [x] Инициализация сигналов с фильтрацией дребезга
  - [x] Диагностика диапазонов (FB_RangeDiagnostic)
  - [x] Интеграция с FB_VibratorControl
  - [x] Интеграция с FB_PneumoCollapseControl
  - [ ] Управление светофором с защитой от ошибок оператора

- [x] FB_VibratorControl - таймерная активация вибраторов
  - [x] Автоматический цикл (IDLE → ACTIVE_WORK → PAUSE_VIBRATOR → PAUSE_FB)
  - [x] Ручной режим управления
  - [x] Настраиваемые параметры (время активности, паузы, количество циклов)

- [x] FB_PneumoCollapseControl - управление пневмообрушением
  - [x] Аналогичная логика циклов
  - [x] Ручной и автоматический режимы

- [ ] FB_TrafficLightControl - управление светофором
  - [ ] Логика переключения с проверкой веса
  - [ ] Защита от ошибок оператора (игнорирование недопустимых действий)
  - [ ] Всплывающие уведомления

### 3.2 Управление конвейером
**Статус**: Завершено

- [x] FB_ConveyorControl - контроллер сборного конвейера
  - [x] Предпусковая сигнализация (FB_PreStartAlarm)
  - [x] Автомат пуска (IDLE → PRESTART_ALARM → STARTING → WORK)
  - [x] Синхронизация моторов
  - [x] Плавный разгон с FB_FrequencyControl
  - [x] Режим симуляции

### 3.3 Управление отвалообразователем
**Статус**: Частично завершено

- [x] FB_DumperControl - контроллер отвалообразователя
  - [x] Управление лентой (аналогично конвейеру)
  - [x] Предпусковая сигнализация
  - [x] Синхронизация моторов
  - [x] Режим симуляции

- [ ] FB_DumperRotationControl / логика поворота
  - [x] Концевые выключатели инициализированы
  - [ ] Позиционирование по времени
  - [ ] Калибровка нулевой точки
  - [ ] Блокировка по концевикам

---

## Фаза 4: Система блокировок - В ПРОЦЕССЕ (40%)

### 4.1 Локальные блокировки
**Статус**: Частично реализовано

- [x] Блокировки в FC_*GetError* функциях
- [x] Проверка QF, перегрева статора, аварий ПЧ
- [x] Условия запуска в xStartCondition/xStopCondition
- [ ] Логика автоматического сброса (температура, вес)
- [ ] Логика ручного сброса (квитирование)

### 4.2 Межсекционные блокировки
**Статус**: Не реализовано

- [x] FC_Bunker_GetErrorWeight - проверка 2+ пустых бункеров
- [ ] FB_InterlockManager - менеджер блокировок
  - [ ] Каскадная остановка (отвал → конвейер → питатели → обрушение)
  - [ ] Условия запуска (зависимости между секциями)
  - [ ] Опционально отключаемые блокировки

### 4.3 КИУМ
**Статус**: Базовая реализация

- [x] Переменная ICUR_PRECENT в MAIN.st
- [x] Проверка ICUR_PRECENT >= 100 в FC_Get_ErrorCommon
- [ ] FB_KIUMController - контроллер мощности
  - [ ] Учет всех нагрузок
  - [ ] Приоритеты включения
  - [ ] Расчет бюджета перед каждым включением
  - [ ] Интеграция с ПЧ (ток → мощность)

---

## Фаза 5: Автоматический режим - В ПРОЦЕССЕ (75%)

### 5.1 Основной алгоритм шихтования
**Статус**: Структура реализована, детали требуют доработки

- [x] Реализация в MAIN.st
  - [x] IDLE - ожидание задания пропорции
  - [x] INIT - проверка суммы = 100%
  - [x] START_DUMPER - запуск отвалообразователя
  - [x] START_CONV - запуск конвейера
  - [ ] START_VIBFEEDER - запуск вибропитателей (TODO в коде)
  - [x] WORK - нормальная работа
  - [ ] END_REPORT - формирование отчета (TODO в коде)
  - [x] ERROR - обработка ошибок

- [x] Проверка пропорции = 100%
- [x] Интеграция с FB_DumperControl и FB_ConveyorControl
- [ ] Переход в ERROR при возникновении ошибок (закомментирован)

### 5.2 Расчет производительности
**Статус**: Реализован

- [x] FB_ProportionPID - ПИД-регулирование пропорций
  - [x] Три независимых ПИД-регулятора
  - [x] Нормализация пропорций
  - [x] Адаптивное масштабирование частот
  - [x] Ограничения оборудования (min/max частота)
  - [x] Диагностические выходы

- [x] Применение частот к бункерам в MAIN.st

---

## Фаза 6: Отчетность и наработка - НЕ НАЧАТА

### 6.1 Счетчики наработки
**Статус**: Не реализовано

- [ ] FB_OperatingHoursCounter - счетчик моточасов
- [ ] Применение ко всем приводам
- [ ] Интерфейс трех ячеек (веха, наработка, до ремонта)

### 6.2 Отчеты бункера
**Статус**: Не реализовано

- [ ] Потребленная энергия (расчетная)
- [ ] Перемещенный вес
- [ ] Превышения температуры
- [ ] Наработка вибраторов
- [ ] Наработка вибропитателей
- [ ] Наработка компрессора
- [ ] Количество срабатываний пневмообрушения

### 6.3 Отчеты конвейера
**Статус**: Не реализовано

- [ ] Потребленная энергия
- [ ] Перемещенный вес (требуются конвейерные весы)
- [ ] Превышения температуры
- [ ] Срабатывания металлодетектора
- [ ] Наработка ленты
- [ ] Наработка приводов

### 6.4 Отчеты отвалообразователя
**Статус**: Не реализовано

- [ ] Потребленная энергия
- [ ] Превышения температуры
- [ ] Наработка ленты
- [ ] Наработка приводов
- [ ] Наработка поворотного механизма

### 6.5 Отчет КИУМ
**Статус**: Не реализовано

- [ ] Тренд суммарной расчетной мощности
- [ ] Тренд мощности от счетчика энергии

---

## Фаза 7: Настройки и администрирование - ЧАСТИЧНО (30%)

### 7.1 Уставки администратора
**Статус**: Частично через глобальные константы

- [x] Температурные уставки (MOTOR_*_TEMP_POINTS, MOTOR_*_CURRENT_POINTS)
- [x] Настройки ПЧ (VFD_FREQUENCY_MAX, VFD_FREQUENCY_STEP)
- [x] Настройки предпускового оповещения (*_PRESTART_ALARM_SETTINGS)
- [x] Настройки вибраторов (VIBRATOR_SETTINGS)
- [ ] Максимальный вес бункеров
- [ ] Периоды обслуживания
- [ ] Опциональные блокировки (вкл/выкл)

### 7.2 Уставки оператора
**Статус**: Частично

- [x] Пропорции шихтования (cmdSetPrecentBunker)
- [x] Параметры ПИД-регулятора
- [ ] Периоды таймеров обрушения (через SCADA)
- [ ] Позиция отвалообразователя

---

## Фаза 8: Тестирование и отладка - В ПРОЦЕССЕ (50%)

### 8.1 Модульное тестирование
**Статус**: Не начато формально

- [ ] Тесты функций проверки ошибок
- [ ] Тесты блокировок
- [ ] Тесты КИУМ

### 8.2 Интеграционное тестирование
**Статус**: Не начато

- [ ] Полный цикл шихтования
- [ ] Каскадная остановка
- [ ] Восстановление после ошибок

### 8.3 Симуляция
**Статус**: Реализовано

- [x] Режим SIMULATION в FB_DumperControl
- [x] Режим SIMULATION в FB_ConveyorControl
- [x] FB_FrequencySimulation - симуляция разгона ПЧ
- [x] Имитация датчиков (QF, KM, HQ, ZQ, и т.д.)
- [ ] Режим SIMULATION в FB_BunkerControl

---

## Библиотека (Library/) - ЗАВЕРШЕНА

### Универсальные блоки
- [x] FB_UniversalSignal - обработка дискретных сигналов
- [x] FB_UniversalAnalogSignal - обработка аналоговых сигналов
- [x] FB_UniversalMechanism - управление механизмами
- [x] FB_FrequencyControl - плавное управление частотой
- [x] FB_FrequencySimulation - симуляция частоты
- [x] FB_PreStartAlarm - предпусковая сигнализация
- [x] FB_RangeDiagnostic - диагностика диапазонов (L/LL/H/HH)
- [x] FB_NumericChangeDetector - детектор изменения значений

### Утилиты
- [x] U_RealToWord - преобразование REAL в WORD
- [x] U_ByteToWord - преобразование BYTE в WORD
- [x] FC_SwapBytesInWord - перестановка байтов
- [x] FC_SwapBytesInWordArray - перестановка в массиве
- [x] FC_SwapWordArrayElements - перестановка элементов

---

## Приоритетные задачи для завершения MVP

### Критические (блокируют работу системы)
1. **START_VIBFEEDER** - логика последовательного запуска вибропитателей с проверкой КИУМ
2. **Каскадная остановка** - FB_InterlockManager или логика в MAIN.st
3. **Раскомментировать переход в ERROR** при ошибках
4. **Поворот отвалообразователя** - базовая логика позиционирования

### Высокие (важны для полноценной работы)
5. **FB_KIUMController** - расчет и проверка бюджета мощности
6. **FB_TrafficLightControl** - управление светофором с защитой
7. **Квитирование ошибок** - логика сброса
8. **Симуляция бункера** - режим SIMULATION в FB_BunkerControl

### Средние (улучшают качество)
9. **END_REPORT** - формирование отчета о выполнении
10. **Конвейерные весы** - добавить в ST_ConveyorBasic

---

## Обновленная временная оценка

| Фаза | Оставшиеся задачи | Оценка (дни) | Статус |
|------|-------------------|--------------|--------|
| 3. Управление | 3 | 2-3 | Почти готово |
| 4. Блокировки | 4 | 3-4 | Требует работы |
| 5. Авто режим | 3 | 2-3 | Почти готово |
| 6. Отчетность | 20+ | 5-7 | Не начато |
| 7. Настройки | 4 | 1-2 | Частично |
| 8. Тестирование | 6 | 3-5 | В процессе |
| **До MVP** | **10** | **7-10** | - |
| **Полная версия** | **40+** | **20-25** | - |

---

## Контрольные точки (Milestones)

### M1: Базовая структура - ДОСТИГНУТА
- [x] Все структуры данных созданы
- [x] Все перечисления созданы
- [x] Библиотека универсальных блоков готова

### M2: Проверки и управление - ДОСТИГНУТА
- [x] Все функции проверки ошибок
- [x] Базовое управление оборудованием
- [x] Предпусковая сигнализация
- [x] Симуляция для отвалообразователя и конвейера

### M3: Автоматический режим (MVP) - В ПРОЦЕССЕ
- [x] Структура автомата состояний
- [x] Запуск отвалообразователя и конвейера
- [x] ПИД-регулирование пропорций
- [ ] Запуск вибропитателей с КИУМ
- [ ] Каскадная остановка
- [ ] Переход в ERROR

### M4: Полный функционал
- [ ] КИУМ полностью работает
- [ ] Поворот отвалообразователя
- [ ] Квитирование ошибок
- [ ] Светофор с защитой

### M5: Готовность к эксплуатации
- [ ] Счетчики наработки
- [ ] Отчеты
- [ ] Все тесты пройдены

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| КИУМ не работает корректно | Средняя | Высокое | Начать с простого расчета, калибровать по счетчику |
| Позиционирование отвалообразователя | Высокая | Среднее | MVP без точного позиционирования, только концевики |
| Каскадная остановка пропускает оборудование | Средняя | Высокое | Тщательное тестирование на симуляции |
| Блокировки конфликтуют | Средняя | Высокое | Матрица блокировок, пошаговая проверка |

---

## Следующие шаги

1. Реализовать START_VIBFEEDER в MAIN.st
2. Добавить логику каскадной остановки
3. Раскомментировать переход в ERROR
4. Протестировать полный цикл на симуляции
5. Добавить базовую логику поворота отвалообразователя
