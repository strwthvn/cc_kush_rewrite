# Архитектурный чек-лист PLC (IEC 61131-3)

> Назначение документа: **быстрая и жёсткая проверка архитектурного качества FB / проекта ПЛК**.
>
> Если пункт вызывает сомнение или ответ «ну почти» — архитектура уже деградирует.

---

## 1. Общие принципы (перед кодом)

* [ ] Проект разбит на **агрегаты (Units)**, а не на «функции»
* [ ] Каждый агрегат имеет **чёткую зону ответственности**
* [ ] Нет «бога-FB», управляющего всем
* [ ] Поведение системы описывается **состояниями**, а не флагами
* [ ] При перезапуске PLC система всегда приходит в **безопасное состояние**

---

## 2. Структура Function Block (FB)

### 2.1 Ответственность FB

* [ ] FB выполняет **ровно одну роль** (агрегат / устройство / сервис)
* [ ] FB можно удалить из проекта и логика остальных FB не сломается
* [ ] FB можно симулировать без реального IO

### 2.2 Внутренняя структура FB

Рекомендуемая логическая структура:

```
VAR_INPUT    // команды, внешние статусы
VAR_OUTPUT   // состояния, статусы
VAR          // внутреннее состояние (FSM, таймеры)
```

* [ ] Нет прямого доступа к глобальным переменным
* [ ] Нет работы с физическим IO внутри агрегатного FB
* [ ] Нет логики SCADA внутри агрегатного FB

---

## 3. FSM (Finite State Machine)

### 3.1 Обязательные требования

* [ ] FSM выражен **явным ENUM**
* [ ] Текущее состояние хранится **в одной переменной**
* [ ] Переходы между состояниями видны в одном месте

### 3.2 Правила состояний

* [ ] INIT — всегда существует
* [ ] FAULT — устойчивое состояние
* [ ] Автовыход из FAULT запрещён
* [ ] RUNNING не содержит сложной логики
* [ ] STOPPING — отдельное состояние, а не IF

### 3.3 Антипаттерны FSM

* [ ] Нет подстадий на INT/CASE
* [ ] Нет нескольких FSM в одном FB без явного разделения
* [ ] Нет переходов в нескольких местах программы

---

## 4. Команды (Commands)

### 4.1 Общие правила

* [ ] Команда — **импульс**, а не состояние
* [ ] Команды не хранятся внутри FB дольше одного цикла
* [ ] Команды приходят только через VAR_INPUT

### 4.2 Типовые команды

* [ ] cmdStart
* [ ] cmdStop
* [ ] cmdReset
* [ ] cmdEnable (если требуется)

### 4.3 Антипаттерны команд

* [ ] Кнопка = состояние RUN
* [ ] SCADA удерживает команду TRUE
* [ ] Несколько FB пишут одну команду

---

## 5. Статусы и состояния (Status)

### 5.1 Правила статусов

* [ ] Статус отражает **реальное состояние**, а не желание
* [ ] Каждый статус имеет **одного владельца**
* [ ] Статус не сбрасывается из SCADA

### 5.2 Типовые статусы

* [ ] stReady
* [ ] stRunning
* [ ] stStopped / stIdle
* [ ] stFault

### 5.3 Антипаттерны

* [ ] Статус вычисляется из таймера + флага
* [ ] Статус залипает без FSM

---

## 6. Single Writer Principle

* [ ] Каждая переменная имеет **один FB-владелец**
* [ ] Нет ситуации, где два FB пишут один сигнал
* [ ] Выходы FB не перезаписываются извне

Если принцип нарушен — проект не масштабируется.

---

## 7. Работа со временем

### 7.1 Таймеры

* [ ] Таймер принадлежит конкретному состоянию
* [ ] Таймер сбрасывается явно
* [ ] Нет глобальных таймеров «на всё»

### 7.2 Антипаттерны времени

* [ ] TON используется как событие
* [ ] Таймер живёт вне FSM

---

## 8. Исполнительные механизмы (Drives, Valves, Actuators)

### 8.1 Архитектура

* [ ] Исполнительный механизм — отдельный FB
* [ ] Агрегат управляет механизмом **через команды**, не напрямую

### 8.2 Контракты

* [ ] Cmd: Start / Stop / Setpoint
* [ ] Status: Ready / Running / Fault

### 8.3 Антипаттерны

* [ ] FSM пишет в выходы VFD напрямую
* [ ] Частоты / давления задаются из FSM

---

## 9. Датчики (Sensors)

### 9.1 Архитектура

* [ ] Каждый датчик инкапсулирован в FB
* [ ] Фильтрация и диагностика — внутри FB датчика

### 9.2 Выходы датчика

* [ ] Value
* [ ] Valid
* [ ] Fault

### 9.3 Антипаттерны

* [ ] FSM проверяет «сырые» входы
* [ ] Дребезг обрабатывается в агрегате

---

## 10. SCADA / HMI

### 10.1 Принципы

* [ ] SCADA не содержит логики процесса
* [ ] SCADA не принимает решений
* [ ] SCADA не хранит состояние агрегата

### 10.2 Разрешено

* [ ] Отображение статусов
* [ ] Отправка команд
* [ ] Квитирование аварий

### 10.3 Запрещено

* [ ] Управление последовательностью
* [ ] Аварийная логика
* [ ] Обход FSM

---

## 11. Инициализация и перезапуск

* [ ] INIT состояние существует явно
* [ ] После рестарта PLC агрегат не запускается сам
* [ ] Все команды сброшены

---

## 12. Масштабирование и сопровождение

* [ ] FB можно клонировать без правок
* [ ] Добавление нового агрегата не требует изменения старых
* [ ] Логику можно объяснить без запуска PLC

---

## 13. Финальная проверка (жёсткая)

Ответь «да» на всё:

* [ ] Я могу доказать корректность переходов FSM
* [ ] Я знаю владельца каждой переменной
* [ ] SCADA не может сломать агрегат
* [ ] При аварии система предсказуема
* [ ] Код скучен и очевиден

Если где-то ответ «ну почти» — **возвращайся вверх**.

---

> **Хорошая архитектура PLC — это когда система не даёт инженеру ошибиться.**
