# Архитектура PLC‑проекта и иерархия Function Block

> Документ предназначен для проектирования **структуры кода PLC** (IEC 61131‑3, ST) до начала реализации.
> Фокус — **детерминизм, масштабируемость, тестируемость**, а не «чтобы работало».

---

## 1. Базовый принцип

**PLC — это детерминированная циклическая машина.**
Архитектура строится вокруг:

* явного порядка вызовов
* чёткого владения состоянием
* строгих границ ответственности

> В PLC порядок исполнения = архитектура.

---

## 2. Общая иерархия уровней

```
LEVEL 0 — Hardware IO
LEVEL 1 — Device Abstraction
LEVEL 2 — Unit / Aggregate (FSM)
LEVEL 3 — Orchestration (Line / Plant)
LEVEL 4 — SCADA / External Interface
```

Каждый уровень:

* знает **только о нижележащем**
* не управляет логикой вышележащего

---

## 3. LEVEL 0 — Hardware IO

### Назначение

* изоляция %IX / %QX
* нормализация сигналов

### Типовые FB

* `FB_DigitalInput`
* `FB_DigitalOutput`
* `FB_AnalogInput`
* `FB_AnalogOutput`

### Правила

* ❌ никакой логики агрегатов
* ❌ никаких FSM
* ❌ никаких команд
* ✔️ только обработка сигнала

---

## 4. LEVEL 1 — Device Abstraction

### Назначение

* абстракция физического устройства

### Примеры

* `FB_MotorStarter`
* `FB_VFD`
* `FB_Valve`
* `FB_Sensor`

### Характеристики

* знает *как* управлять устройством
* не знает *зачем*
* может использовать IO‑FB

### Запрещено

* ❌ знания о процессе
* ❌ знания о SCADA

---

## 5. LEVEL 2 — Unit / Aggregate

### Назначение

* управление **одним агрегатом**
* владение FSM

### Примеры

* `FB_PumpUnit`
* `FB_ConveyorUnit`
* `FB_DumperUnit`

### Обязанности

* FSM агрегата
* проверка инвариантов
* управление Device‑FB
* обработка локальных ошибок

### Правила

* ✔️ один агрегат = один FSM
* ❌ прямой доступ к IO
* ❌ логика SCADA

---

## 6. LEVEL 3 — Orchestration

### Назначение

* координация агрегатов
* выбор источника команд

### Примеры

* `FB_PumpController`
* `FB_LineController`

### Обязанности

* Auto / Manual логика
* interlock между агрегатами
* последовательности пуска

### Запрещено

* ❌ управление IO
* ❌ внутренние FSM агрегатов

---

## 7. LEVEL 4 — SCADA Interface

### Назначение

* адаптация внешнего мира

### Примеры

* `FB_PumpScadaAdapter`
* `FB_LineScadaAdapter`

### Обязанности

* маппинг команд
* нормализация статусов

### Жёсткие запреты

* ❌ принятие решений
* ❌ управление устройствами

---

## 8. Aggregate FB (верхний уровень)

### Назначение

* явное владение всеми под‑FB агрегата
* контроль порядка вызова

### Пример

```
FB_PumpAggregate
 ├─ FB_DigitalInput
 ├─ FB_MotorStarter
 ├─ FB_PumpUnit
 ├─ FB_PumpController
 ├─ FB_PumpScadaAdapter
 └─ FB_DigitalOutput
```

### Правила

* ✔️ FB владеет под‑FB
* ✔️ порядок вызова задаётся явно
* ❌ STRUCT с FB запрещены

---

## 9. STRUCT в архитектуре

### Разрешено

* состояния
* команды
* статусы
* ошибки
* конфигурация

### Запрещено

* ❌ FUNCTION_BLOCK
* ❌ таймеры
* ❌ FSM

> STRUCT = данные, FB = поведение

---

## 10. MAIN

### Роль

* инстанцирование агрегатов
* связывание линий

### Принцип

* MAIN не содержит логики
* MAIN не содержит FSM

---

## 11. Поток сигналов

### Команды

```
SCADA → Adapter → Orchestration → Unit → Device → IO
```

### Обратная связь

```
IO → Device → Unit → Adapter → SCADA
```

---

## 12. Антипаттерны

* STRUCT с FB внутри
* несколько FSM в одном FB
* прямое управление IO из Unit
* логика SCADA в PLC
* неявный порядок вызовов

---

## 13. Контрольные вопросы

* Где живёт FSM агрегата?
* Кто владеет таймерами?
* Кто последний пишет в выход?
* Можно ли протестировать Unit без IO?

Если нет чёткого ответа — архитектура нарушена.

---

## 14. Критерий зрелости

Проект считается архитектурно зрелым, если:

* агрегаты клонируются без правки кода
* SCADA заменяется без изменения FSM
* порядок вызовов очевиден из структуры FB

---

**Конец документа**
