# Скрипт конвертации MODBUS_MAP.md в CSV

## Описание

Python скрипт для автоматической конвертации карты Modbus регистров из Markdown формата в CSV файлы.

## Структура

```
script/
├── modbus_md_to_csv.py    # Основной скрипт конвертации
├── output/                 # Выходная папка с CSV файлами
│   ├── MODBUS_MAP_FULL.csv                # Объединенный файл (все регистры)
│   ├── Holding_регистры_...*.csv          # Holding регистры по секциям
│   └── Input_регистры_...*.csv            # Input регистры по секциям
└── README.md               # Этот файл
```

## Использование

### Запуск скрипта

```bash
cd /home/dmalikov/dev/cc_kush_rewrite/newProject/script
python3 modbus_md_to_csv.py
```

### Результат работы

Скрипт создает:

1. **38 отдельных CSV файлов** - разбивка по секциям:
   - Holding регистры (SCADA → PLC) - уставки
   - Input регистры (PLC → SCADA) - мониторинг

2. **1 объединенный файл** `MODBUS_MAP_FULL.csv`:
   - Все регистры в одном файле
   - Дополнительные колонки: `Тип_регистра`, `Секция`
   - **808 строк данных**

### Статистика

- **Всего строк во всех CSV**: ~1655
- **Файлов создано**: 39
- **Размер папки output**: ~244 KB

## Структура CSV файлов

### Булевы флаги (битовые регистры)

```csv
Бит,Переменная,Описание
0.0,stCommands.cmdStartCommon,Команда общего ПУСК
0.1,stCommands.cmdStopCommon,Команда общего СТОП
...
```

### REAL регистры

```csv
Регистр,Тип,Переменная,Описание
32-33,REAL,VFD_FREQUENCY_MAX,Максимальная частота ЧРП
34-35,REAL,VFD_FREQUENCY_STEP,Шаг изменения частоты
...
```

### Объединенный файл MODBUS_MAP_FULL.csv

```csv
Тип_регистра,Секция,Колонка_1,Колонка_2,Колонка_3,Колонка_4
Holding,Общие системные переменные и уставки (0-29),0.0,stCommands.cmdStartCommon,Команда общего ПУСК,
Input,Бункер 1 (30-89),30.0,stBunker[1].xStateEnable,Состояние: Включен,
...
```

## Особенности парсинга

Скрипт автоматически:

- ✅ Распознает разделы (## и ###)
- ✅ Парсит Markdown таблицы
- ✅ Разделяет Holding и Input регистры
- ✅ Сохраняет иерархию секций в именах файлов
- ✅ Обрабатывает кириллицу (UTF-8)
- ✅ Создает объединенный файл с контекстом

## Требования

- Python 3.6+
- Стандартные библиотеки: `re`, `csv`, `os`, `pathlib`

## Примеры использования CSV

### Импорт в Excel/LibreOffice

```bash
# Открыть файл в LibreOffice Calc
libreoffice --calc output/MODBUS_MAP_FULL.csv
```

### Поиск по регистрам

```bash
# Найти все регистры с частотой
grep -i "frequency" output/MODBUS_MAP_FULL.csv

# Найти регистры бункера 1
grep "Бункер 1" output/MODBUS_MAP_FULL.csv
```

### Фильтрация в Python

```python
import pandas as pd

# Загрузить объединенный файл
df = pd.read_csv('output/MODBUS_MAP_FULL.csv')

# Получить только Holding регистры
holding = df[df['Тип_регистра'] == 'Holding']

# Получить регистры бункера 1
bunker1 = df[df['Секция'].str.contains('Бункер 1')]

# Сохранить в Excel
df.to_excel('modbus_map.xlsx', index=False)
```

## Обновление данных

При изменении `MODBUS_MAP.md` просто запустите скрипт заново:

```bash
python3 modbus_md_to_csv.py
```

Все CSV файлы в папке `output/` будут перезаписаны с актуальными данными.

## Автор

Создано для проекта автоматизации промышленной системы управления конвейерами.
